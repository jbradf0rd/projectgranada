{% extends "base.html" %}

{% block title %}الإعدادات - غرناطة{% endblock %}

{% block content %}
<div class="container" x-data="settingsPage()">
    <h2 style="margin-bottom: var(--spacing-xl);">الإعدادات</h2>

    <!-- Application Section -->
    <div class="settings-section">
        <div class="settings-section-title">التطبيق</div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>مشاركة التطبيق</span>
                <span class="settings-item-description">شارك غرناطة مع أصدقائك</span>
            </div>
            <button class="btn" @click="shareApp()">مشاركة</button>
        </div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>حول التطبيق</span>
                <span class="settings-item-description">غرناطة v2.0.0</span>
            </div>
        </div>
    </div>

    <!-- Preferences Section -->
    <div class="settings-section">
        <div class="settings-section-title">التفضيلات</div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>الوضع الداكن</span>
                <span class="settings-item-description">تفعيل المظهر الداكن</span>
            </div>
            <label class="toggle">
                <input type="checkbox" x-model="settings.theme" :checked="settings.theme === 'dark'" @change="toggleTheme()">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>إبقاء الشاشة مضاءة</span>
                <span class="settings-item-description">منع إيقاف الشاشة أثناء القراءة</span>
            </div>
            <label class="toggle">
                <input type="checkbox" x-model="settings.keep_screen_on" @change="saveSettings()">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>فتح البحث أولاً</span>
                <span class="settings-item-description">البدء بصفحة البحث عند فتح التطبيق</span>
            </div>
            <label class="toggle">
                <input type="checkbox" x-model="settings.open_search_first" @change="saveSettings()">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <!-- Data & Storage Section -->
    <div class="settings-section">
        <div class="settings-section-title">البيانات والتخزين</div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>حجم البيانات</span>
                <span class="settings-item-description" x-text="dataSize"></span>
            </div>
        </div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>تصدير البيانات</span>
                <span class="settings-item-description">نسخ احتياطي لبياناتك</span>
            </div>
            <button class="btn" @click="exportData()">تصدير</button>
        </div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>استيراد البيانات</span>
                <span class="settings-item-description">استعادة من نسخة احتياطية</span>
            </div>
            <button class="btn" @click="importData()">استيراد</button>
        </div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>مسح البيانات</span>
                <span class="settings-item-description">حذف جميع البيانات المحلية</span>
            </div>
            <button class="btn btn-danger" @click="clearData()">مسح</button>
        </div>
    </div>

    <!-- AI Section (Granada Feature) -->
    <div class="settings-section">
        <div class="settings-section-title">الذكاء الاصطناعي</div>

        <div class="settings-item" style="flex-direction: column; align-items: stretch;">
            <div class="settings-item-label" style="margin-bottom: var(--spacing-sm);">
                <span>مفتاح Claude API</span>
                <span class="settings-item-description">للاستخدام مع خدمة Claude</span>
            </div>
            <input type="password" class="input-field" placeholder="sk-..." x-model="settings.claude_api_key" @change="saveSettings()">
        </div>

        <div class="settings-item" style="flex-direction: column; align-items: stretch;">
            <div class="settings-item-label" style="margin-bottom: var(--spacing-sm);">
                <span>عنوان Ollama</span>
                <span class="settings-item-description">للاستخدام مع Ollama المحلي</span>
            </div>
            <input type="text" class="input-field" placeholder="http://localhost:11434" x-model="settings.ollama_url" @change="saveSettings()">
        </div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>النموذج</span>
            </div>
            <select class="input-field" style="width: auto;" x-model="settings.ai_model" @change="saveSettings()">
                <option value="claude-sonnet-4-5">Claude Sonnet 4.5</option>
                <option value="claude-opus-4-5">Claude Opus 4.5</option>
                <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
                <option value="ollama-llama2">Ollama Llama 2</option>
                <option value="ollama-mistral">Ollama Mistral</option>
            </select>
        </div>
    </div>

    <!-- Collections Section (Granada Feature) -->
    <div class="settings-section">
        <div class="settings-section-title">المجموعات</div>

        <div class="settings-item">
            <div class="settings-item-label">
                <span>إدارة المجموعات</span>
                <span class="settings-item-description">تعديل وحذف مجموعات القراءة</span>
            </div>
            <a href="/collections" class="btn">إدارة</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsPage() {
    return {
        settings: {
            theme: 'dark',
            keep_screen_on: false,
            open_search_first: true,
            claude_api_key: '',
            ollama_url: 'http://localhost:11434',
            ai_model: 'claude-sonnet-4-5'
        },
        dataSize: 'جاري الحساب...',

        init() {
            this.loadSettings();
            this.calculateDataSize();
        },

        async loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                this.settings = { ...this.settings, ...data };
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        },

        async saveSettings() {
            try {
                await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.settings)
                });
            } catch (error) {
                console.error('Failed to save settings:', error);
            }
        },

        toggleTheme() {
            this.settings.theme = this.settings.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', this.settings.theme);
            this.saveSettings();
        },

        calculateDataSize() {
            // TODO: Get actual data size from API
            this.dataSize = '15.3 MB';
        },

        shareApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'غرناطة',
                    text: 'محرك بحث عربي للكتب',
                    url: window.location.origin
                });
            } else {
                alert('المشاركة غير متاحة في هذا المتصفح');
            }
        },

        exportData() {
            alert('جاري تصدير البيانات...');
            // TODO: Implement export
        },

        importData() {
            alert('اختر ملف النسخة الاحتياطية');
            // TODO: Implement import
        },

        clearData() {
            if (confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                alert('تم مسح البيانات');
                // TODO: Implement clear
            }
        }
    };
}
</script>
{% endblock %}

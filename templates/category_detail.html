{% extends "base.html" %}

{% block title %}القسم - غرناطة{% endblock %}

{% block content %}
<div class="container" x-data="categoryDetailPage()" x-init="init()">
    <!-- Header -->
    <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
        <a href="/categories" class="btn" style="padding: var(--spacing-sm);">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
            </svg>
        </a>
        <h2 class="section-title" style="margin: 0;" x-text="categoryName || 'جاري التحميل...'"></h2>
    </div>

    <!-- Loading State -->
    <div class="loading" x-show="isLoading">
        <div class="loading-spinner"></div>
    </div>

    <!-- Books List -->
    <div x-show="!isLoading && books.length > 0">
        <template x-for="book in books" :key="book.id">
            <div class="book-item">
                <div class="book-info">
                    <div class="book-title">
                        <a :href="'/book/' + book.id" x-text="book.title"></a>
                    </div>
                    <div class="book-meta">
                        <span x-text="book.author"></span>
                    </div>
                </div>
                <button class="delete-btn" @click="confirmDeleteBook(book)" title="حذف الكتاب">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </template>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" x-show="showDeleteModal" @click.self="showDeleteModal = false" style="display: none;" :style="showDeleteModal && {display: 'flex'}">
        <div class="modal-content" @click.stop>
            <h3 style="margin-bottom: var(--spacing-lg); color: var(--danger);">حذف الكتاب</h3>
            <p style="margin-bottom: var(--spacing-lg);">
                هل أنت متأكد من حذف كتاب "<span x-text="bookToDelete?.title"></span>"؟
            </p>
            <p style="margin-bottom: var(--spacing-lg); color: var(--text-muted); font-size: 0.9rem;">
                سيتم حذف الكتاب وجميع صفحاته نهائياً.
            </p>
            <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                <button class="btn" @click="showDeleteModal = false">إلغاء</button>
                <button class="btn btn-danger" @click="deleteBook()" :disabled="isDeleting">
                    <span x-show="!isDeleting">حذف</span>
                    <span x-show="isDeleting">جاري الحذف...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" x-show="!isLoading && books.length === 0">
        <div class="empty-state-icon">&#128218;</div>
        <div class="empty-state-text">لا توجد كتب في هذا القسم</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function categoryDetailPage() {
    return {
        categoryId: {{ category_id }},
        categoryName: '',
        books: [],
        isLoading: true,
        showDeleteModal: false,
        bookToDelete: null,
        isDeleting: false,

        async init() {
            await this.loadCategoryBooks();
        },

        async loadCategoryBooks() {
            this.isLoading = true;
            try {
                const response = await fetch(`/api/categories/${this.categoryId}/books`);
                const data = await response.json();

                if (data.error) {
                    console.error('Category not found');
                    return;
                }

                this.categoryName = data.category?.name || 'القسم';
                this.books = data.books || [];
            } catch (error) {
                console.error('Failed to load category books:', error);
            } finally {
                this.isLoading = false;
            }
        },

        confirmDeleteBook(book) {
            this.bookToDelete = book;
            this.showDeleteModal = true;
        },

        async deleteBook() {
            if (!this.bookToDelete || this.isDeleting) return;

            this.isDeleting = true;
            try {
                const response = await fetch(`/api/books/${this.bookToDelete.id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Remove from local list
                    this.books = this.books.filter(b => b.id !== this.bookToDelete.id);
                    this.showDeleteModal = false;
                    this.bookToDelete = null;
                } else {
                    const data = await response.json();
                    alert(data.message || 'فشل حذف الكتاب');
                }
            } catch (error) {
                console.error('Failed to delete book:', error);
                alert('حدث خطأ أثناء حذف الكتاب');
            } finally {
                this.isDeleting = false;
            }
        }
    };
}
</script>
{% endblock %}

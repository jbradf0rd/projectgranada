{% extends "base.html" %}

{% block title %}المجموعات - غرناطة{% endblock %}

{% block content %}
<div class="container" x-data="collectionsPage()">
    <!-- Header with Add Button -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <h2>مجموعاتي</h2>
        <button class="btn btn-primary" @click="showNewCollectionModal = true">
            إضافة مجموعة
        </button>
    </div>

    <!-- Loading State -->
    <div class="loading" x-show="isLoading">
        <div class="loading-spinner"></div>
    </div>

    <!-- Collections List -->
    <div x-show="!isLoading && collections.length > 0">
        <template x-for="collection in collections" :key="collection.id">
            <div class="collection-item" :class="{ 'expanded': expandedCollection === collection.id }">
                <div class="collection-header" @click="toggleCollection(collection.id)">
                    <div class="collection-title">
                        <span class="collection-toggle">&#9662;</span>
                        <span x-text="collection.name"></span>
                    </div>
                    <div class="collection-stats">
                        <div class="collection-progress">
                            <div class="collection-progress-bar" :style="'width: ' + (collection.progress * 100) + '%'"></div>
                        </div>
                        <span x-text="Math.round(collection.progress * 100) + '%'"></span>
                        <span class="collection-count" x-text="'(' + collection.book_count + ')'"></span>
                    </div>
                </div>
                <div class="collection-books">
                    <template x-for="book in collection.books" :key="book.id">
                        <a :href="'/book/' + book.id" class="collection-book">
                            <div class="collection-book-title">
                                <input type="checkbox" :checked="book.progress.is_complete" disabled>
                                <span x-text="book.title"></span>
                            </div>
                            <span class="collection-book-status" :class="{ 'complete': book.progress.is_complete }">
                                <template x-if="book.progress.is_complete">
                                    <span>&#10003; مكتمل</span>
                                </template>
                                <template x-if="!book.progress.is_complete && book.progress.current_page > 1">
                                    <span x-text="'صفحة ' + book.progress.current_page"></span>
                                </template>
                                <template x-if="!book.progress.is_complete && book.progress.current_page <= 1">
                                    <span>لم يبدأ</span>
                                </template>
                            </span>
                        </a>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div class="empty-state" x-show="!isLoading && collections.length === 0">
        <div class="empty-state-icon">&#128218;</div>
        <div class="empty-state-text">لا توجد مجموعات</div>
        <div class="text-muted">قم بإنشاء مجموعة لتتبع قراءاتك</div>
    </div>

    <!-- New Collection Modal -->
    <div class="overlay" :class="{ 'active': showNewCollectionModal }" @click="showNewCollectionModal = false"></div>
    <div class="popover" x-show="showNewCollectionModal" x-cloak style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px;">
        <div class="popover-header">مجموعة جديدة</div>
        <div style="padding: var(--spacing-md);">
            <input type="text" class="input-field" placeholder="اسم المجموعة" x-model="newCollectionName" @keyup.enter="createCollection()">
            <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                <button class="btn" style="flex: 1;" @click="showNewCollectionModal = false">إلغاء</button>
                <button class="btn btn-primary" style="flex: 1;" @click="createCollection()">إنشاء</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function collectionsPage() {
    return {
        collections: [],
        isLoading: true,
        expandedCollection: null,
        showNewCollectionModal: false,
        newCollectionName: '',

        init() {
            this.loadCollections();
        },

        async loadCollections() {
            this.isLoading = true;
            try {
                const response = await fetch('/api/collections');
                const data = await response.json();
                this.collections = data.collections || [];
            } catch (error) {
                console.error('Failed to load collections:', error);
            } finally {
                this.isLoading = false;
            }
        },

        toggleCollection(collectionId) {
            if (this.expandedCollection === collectionId) {
                this.expandedCollection = null;
            } else {
                this.expandedCollection = collectionId;
            }
        },

        async createCollection() {
            if (!this.newCollectionName.trim()) return;

            try {
                const response = await fetch('/api/collections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: this.newCollectionName })
                });
                const data = await response.json();

                this.collections.push({
                    id: data.id,
                    name: this.newCollectionName,
                    book_count: 0,
                    progress: 0,
                    books: []
                });

                this.newCollectionName = '';
                this.showNewCollectionModal = false;
            } catch (error) {
                console.error('Failed to create collection:', error);
                alert('حدث خطأ أثناء إنشاء المجموعة');
            }
        }
    };
}
</script>
<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}
